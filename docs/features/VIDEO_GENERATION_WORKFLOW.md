# è§†é¢‘ç”Ÿæˆå·¥ä½œæµç¨‹å®Œæ•´æ–‡æ¡£

## ğŸ“‹ ç›®å½•
1. [é—®é¢˜è¯´æ˜](#é—®é¢˜è¯´æ˜)
2. [å½“å‰æ¶æ„](#å½“å‰æ¶æ„)
3. [é—®é¢˜æ ¹æº](#é—®é¢˜æ ¹æº)
4. [è§£å†³æ–¹æ¡ˆ](#è§£å†³æ–¹æ¡ˆ)
5. [n8n å›è°ƒé…ç½®æ­¥éª¤](#n8n-å›è°ƒé…ç½®æ­¥éª¤)
6. [ä¸´æ—¶æ‰‹åŠ¨æ›´æ–°æ–¹æ¡ˆ](#ä¸´æ—¶æ‰‹åŠ¨æ›´æ–°æ–¹æ¡ˆ)
7. [éªŒè¯æµ‹è¯•](#éªŒè¯æµ‹è¯•)

---

## é—®é¢˜è¯´æ˜

**ç°è±¡**ï¼š
- å‰ç«¯æäº¤è§†é¢‘ç”Ÿæˆè¯·æ±‚æˆåŠŸ
- åç«¯è°ƒç”¨ n8n workflow æˆåŠŸ
- n8n æ‰§è¡Œå®Œæˆï¼ˆçº¦50åˆ†é’Ÿï¼‰
- **ä½†å‰ç«¯ä¸€ç›´æ˜¾ç¤º"ç”Ÿæˆä¸­"ï¼Œè·å–ä¸åˆ°è§†é¢‘ URL**

**æ ¹æœ¬åŸå› **ï¼š
**n8n workflow æ‰§è¡Œå®Œæˆåï¼Œæ²¡æœ‰å›è°ƒåç«¯é€šçŸ¥ç»“æœ**

---

## å½“å‰æ¶æ„

```
å‰ç«¯ (PortfolioCreate.tsx)
  â”‚
  â”œâ”€ Step2: ç”Ÿæˆæ•…äº‹ + å›¾ç‰‡
  â”‚   â””â”€> POST /api/ai/generate-story
  â”‚       â””â”€> åç«¯ç›´è¿ ComfyUI
  â”‚           â””â”€> è¿”å› imageJobId
  â”‚
  â””â”€ Step6: ç”Ÿæˆè§†é¢‘
      â”œâ”€> POST /api/drama/generate-video (ä¼ å…¥ scenes)
      â”‚   â””â”€> åç«¯è°ƒç”¨ n8n webhook
      â”‚       â”œâ”€> n8n ç«‹å³è¿”å› (8ç§’å†…)
      â”‚       â””â”€> åç«¯è¿”å› taskId ç»™å‰ç«¯
      â”‚
      â”œâ”€> å‰ç«¯æ¯ 5 ç§’è½®è¯¢: GET /api/drama/task/:taskId
      â”‚   â””â”€> æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€ (running/completed/failed)
      â”‚
      â””â”€> âŒ **é—®é¢˜**: n8n å®Œæˆåæ²¡æœ‰æ›´æ–°åç«¯ä»»åŠ¡çŠ¶æ€
          â””â”€> å¯¼è‡´å‰ç«¯ä¸€ç›´çœ‹åˆ° status: "running"
```

---

## é—®é¢˜æ ¹æº

### å½“å‰æµç¨‹ï¼ˆæœ‰é—®é¢˜ï¼‰

1. åç«¯è°ƒç”¨ n8n webhook âœ…
2. n8n ç«‹å³è¿”å› 200 âœ…
3. åç«¯è¿”å› `taskId` ç»™å‰ç«¯ âœ…
4. n8n åœ¨åå°æ‰§è¡Œ 50 åˆ†é’Ÿ âœ…
5. **âŒ n8n æ‰§è¡Œå®Œæˆï¼Œä½†æ²¡æœ‰é€šçŸ¥åç«¯**
6. å‰ç«¯è½®è¯¢ä¸€ç›´å¾—åˆ° `status: "running"` âŒ

### ä¸ºä»€ä¹ˆ n8n ä¸é€šçŸ¥åç«¯ï¼Ÿ

**å› ä¸º n8n workflow ç¼ºå°‘æœ€åä¸€æ­¥ï¼šå›è°ƒåç«¯çš„ HTTP Request èŠ‚ç‚¹**

---

## è§£å†³æ–¹æ¡ˆ

åœ¨ n8n workflow æœ€åæ·»åŠ ä¸€ä¸ª **HTTP Request èŠ‚ç‚¹**ï¼Œç”¨æ¥å›è°ƒåç«¯ï¼š

```
n8n workflow æµç¨‹:
1. æ¥æ”¶åˆ†é•œ (Webhook)
2. è§£æåˆ†é•œè¾“å…¥
3. éŸ³é¢‘ç”Ÿæˆ
4. è§†é¢‘ç”Ÿæˆ
5. èåˆä»»åŠ¡
6. åˆå¹¶æœ€ç»ˆè§†é¢‘
7. âœ¨ **æ–°å¢: å›è°ƒåç«¯é€šçŸ¥å®Œæˆ** â† è¿™æ˜¯ç¼ºå¤±çš„æ­¥éª¤ï¼
```

---

## n8n å›è°ƒé…ç½®æ­¥éª¤

### 1. æ‰“å¼€ n8n Workflow

è®¿é—®ï¼šhttp://49.235.210.6:5678
æ‰“å¼€ workflow: `story_final_from_scenes`

### 2. æ·»åŠ æ–°èŠ‚ç‚¹

åœ¨ **"åˆå¹¶æœ€ç»ˆè§†é¢‘"** èŠ‚ç‚¹ä¹‹åï¼š
- ç‚¹å‡» "+" æ·»åŠ èŠ‚ç‚¹
- æœç´¢å¹¶é€‰æ‹©ï¼š**HTTP Request**
- èŠ‚ç‚¹åç§°ï¼š`å›è°ƒåç«¯é€šçŸ¥å®Œæˆ`

### 3. é…ç½® HTTP Request èŠ‚ç‚¹

#### Method
```
POST
```

#### URLï¼ˆä½¿ç”¨è¡¨è¾¾å¼ï¼Œç‚¹å‡»æ—è¾¹çš„è¡¨è¾¾å¼å›¾æ ‡ï¼‰
```javascript
{{ $('æ¥æ”¶åˆ†é•œ').item.json.body.callback_url }}
```

**è¯´æ˜**ï¼šè¿™ä¸ª URL æ˜¯åç«¯ä¼ å…¥çš„ï¼Œæ ¼å¼ä¸ºï¼š
```
http://117.50.193.105:3001/api/drama/callback/{taskId}
```

#### Headers
å‹¾é€‰ **Send Headers**ï¼Œæ·»åŠ ï¼š
- Name: `Content-Type`
- Value: `application/json`

#### Body
å‹¾é€‰ **Send Body**
é€‰æ‹© **Body Content Type**: `JSON`

ç‚¹å‡» **JSON/RAW Parameters** çš„è¡¨è¾¾å¼å›¾æ ‡ï¼Œè¾“å…¥ï¼š

```javascript
{
  "status": "completed",
  "videoUrl": "http://49.235.210.6:8001/output/{{ $json.filename }}"
}
```

**âš ï¸ é‡è¦**ï¼š`$json.filename` éœ€è¦æ ¹æ®"åˆå¹¶æœ€ç»ˆè§†é¢‘"èŠ‚ç‚¹çš„å®é™…è¾“å‡ºå­—æ®µè°ƒæ•´ã€‚

å¯èƒ½çš„å­—æ®µåï¼š
- `filename` ï¼ˆæœ€å¸¸è§ï¼‰
- `output_filename`
- `video_filename`
- `output_file`

**å¦‚ä½•ç¡®å®šå­—æ®µå**ï¼š
1. åœ¨ n8n ä¸­æ‰§è¡Œä¸€æ¬¡ workflow
2. æŸ¥çœ‹"åˆå¹¶æœ€ç»ˆè§†é¢‘"èŠ‚ç‚¹çš„è¾“å‡ºæ•°æ®
3. æ‰¾åˆ°åŒ…å«æ–‡ä»¶åçš„å­—æ®µ

**æˆ–è€…ç›´æ¥ä½¿ç”¨å®Œæ•´ URL**ï¼ˆå¦‚æœåˆå¹¶èŠ‚ç‚¹è¿”å›å®Œæ•´ URLï¼‰ï¼š
```javascript
{
  "status": "completed",
  "videoUrl": "{{ $json.video_url }}"
}
```

### 4. è¿æ¥èŠ‚ç‚¹

å°† **"åˆå¹¶æœ€ç»ˆè§†é¢‘"** çš„è¾“å‡ºè¿æ¥åˆ° **"å›è°ƒåç«¯é€šçŸ¥å®Œæˆ"**

### 5. æµ‹è¯•

ç‚¹å‡» **"Execute Workflow"** æ‰‹åŠ¨æµ‹è¯•ï¼š
1. ä½¿ç”¨æµ‹è¯•æ•°æ®æ‰§è¡Œ
2. æŸ¥çœ‹"å›è°ƒåç«¯é€šçŸ¥å®Œæˆ"èŠ‚ç‚¹æ˜¯å¦æˆåŠŸï¼ˆç»¿è‰²å‹¾ï¼‰
3. æ£€æŸ¥åç«¯æ—¥å¿—ï¼š

```bash
tail -f /tmp/writetalent_deepseek.log | grep Callback
```

åº”è¯¥çœ‹åˆ°ï¼š
```
ğŸ“¥ [Callback] Received n8n callback for task video_xxx
âœ… [Callback] Task video_xxx completed with video: http://49.235.210.6:8001/output/...
```

### 6. ä¿å­˜å¹¶æ¿€æ´»

- ç‚¹å‡» **Save** ä¿å­˜ workflow
- ç¡®ä¿ workflow å¤„äº **æ¿€æ´»çŠ¶æ€**ï¼ˆå¼€å…³æ‰“å¼€ï¼‰

---

## ä¸´æ—¶æ‰‹åŠ¨æ›´æ–°æ–¹æ¡ˆ

**åœ¨ n8n å›è°ƒé…ç½®å®Œæˆä¹‹å‰ï¼Œå¯ä»¥æ‰‹åŠ¨æ›´æ–°ä»»åŠ¡çŠ¶æ€ï¼š**

### æ–¹æ³•1ï¼šä½¿ç”¨è„šæœ¬

```bash
/tmp/update_video_task.sh <taskId> <videoUrl>
```

ç¤ºä¾‹ï¼š
```bash
/tmp/update_video_task.sh video_1763294577131_z5hfvwlf4 \
  http://49.235.210.6:8001/output/final_story_video_2025-11-16T13-24-03-478085.mp4
```

### æ–¹æ³•2ï¼šä½¿ç”¨ curl

```bash
curl -X POST 'http://localhost:3001/api/drama/callback/<taskId>' \
  -H 'Content-Type: application/json' \
  -d '{
    "status": "completed",
    "videoUrl": "<è§†é¢‘URL>"
  }'
```

### å¦‚ä½•è·å–ä¿¡æ¯

**taskId**ï¼š
- æ–¹å¼1ï¼šæŸ¥çœ‹å‰ç«¯æµè§ˆå™¨ Consoleï¼š`âœ… Video task created: video_xxx`
- æ–¹å¼2ï¼šæŸ¥çœ‹åç«¯æ—¥å¿—ï¼š`grep "Callback URL for task" /tmp/writetalent_deepseek.log | tail -1`

**videoUrl**ï¼š
1. è®¿é—® n8nï¼šhttp://49.235.210.6:5678
2. æŸ¥çœ‹ workflow æ‰§è¡Œè®°å½•
3. ç‚¹å‡»"åˆå¹¶æœ€ç»ˆè§†é¢‘"èŠ‚ç‚¹
4. æŸ¥çœ‹è¾“å‡ºæ•°æ®ä¸­çš„è§†é¢‘ URL

---

## éªŒè¯æµ‹è¯•

### å®Œæ•´æµ‹è¯•æµç¨‹

1. **å‰ç«¯æ“ä½œ**ï¼š
   - è¿›å…¥ Step6
   - ç‚¹å‡» "Generate Video"
   - è§‚å¯Ÿ Console è¾“å‡º

2. **é¢„æœŸè¡Œä¸º**ï¼š
   ```javascript
   ğŸ¬ [Step6] Calling video generation API with scenes: 6
   âœ… Video task created: video_xxx
   ğŸ¬ Video task video_xxx status: running progress: 10%
   // ... ç­‰å¾…çº¦50åˆ†é’Ÿ ...
   ğŸ¬ Video task video_xxx status: completed progress: 100%
   âœ… Video generation completed: http://49.235.210.6:8001/output/...
   ```

3. **åç«¯æ—¥å¿—éªŒè¯**ï¼š
   ```bash
   tail -f /tmp/writetalent_deepseek.log
   ```

   åº”è¯¥çœ‹åˆ°ï¼š
   ```
   ğŸ“¥ [Step6] Received request, body keys: [ 'scenes' ]
   ğŸ¬ [Step6] Triggering video generation for 6 scenes
   ğŸ“¡ Calling n8n webhook: http://49.235.210.6:5678/webhook/story_final_v2
   âœ… n8n workflow triggered, execution ID: unknown
   // ... 50åˆ†é’Ÿå ...
   ğŸ“¥ [Callback] Received n8n callback for task video_xxx
   âœ… [Callback] Task video_xxx completed with video: http://...
   ```

4. **å‰ç«¯æ˜¾ç¤ºéªŒè¯**ï¼š
   - è¿›åº¦æ¡åˆ° 100%
   - æ˜¾ç¤º "Video Ready! ğŸ‰"
   - å‡ºç°è§†é¢‘æ’­æ”¾å™¨ï¼Œå¯ä»¥æ’­æ”¾ç”Ÿæˆçš„è§†é¢‘

---

## åç«¯ API è¯´æ˜

### POST /api/drama/generate-video

**è¯·æ±‚**ï¼š
```json
{
  "scenes": [
    {
      "id": 1,
      "durationSeconds": 6,
      "story": "æ•…äº‹æ–‡æœ¬",
      "voicePrompt": "æ—ç™½æ–‡æœ¬",
      "videoPrompt": "è§†é¢‘æç¤ºè¯",
      "imagePrompt": "å›¾ç‰‡æç¤ºè¯"
    }
  ]
}
```

**å“åº”**ï¼š
```json
{
  "success": true,
  "taskId": "video_1763294577131_z5hfvwlf4",
  "status": "running",
  "message": "è§†é¢‘ç”Ÿæˆä»»åŠ¡å·²æäº¤åˆ° n8nï¼Œè¯·è½®è¯¢ä»»åŠ¡çŠ¶æ€",
  "n8nExecutionId": "unknown"
}
```

### GET /api/drama/task/:taskId

**å“åº”**ï¼š
```json
{
  "success": true,
  "task": {
    "id": "video_1763294577131_z5hfvwlf4",
    "type": "video",
    "status": "running",  // running | completed | failed
    "progress": 10,       // 0-100
    "result": {           // å®Œæˆæ—¶æ‰æœ‰
      "videoUrl": "http://49.235.210.6:8001/output/final_story_video_xxx.mp4"
    },
    "error": null,
    "n8nExecutionId": "unknown",
    "createdAt": "2025-11-16T12:02:57.131Z",
    "updatedAt": "2025-11-16T12:02:57.387Z"
  }
}
```

### POST /api/drama/callback/:taskId

**ç”± n8n è°ƒç”¨ï¼Œä¸æ˜¯å‰ç«¯è°ƒç”¨**

**è¯·æ±‚**ï¼š
```json
{
  "status": "completed",
  "videoUrl": "http://49.235.210.6:8001/output/final_story_video_xxx.mp4"
}
```

**å“åº”**ï¼š
```json
{
  "success": true,
  "message": "Task updated"
}
```

---

## å¸¸è§é—®é¢˜

### Q1: ä¸ºä»€ä¹ˆä¸èƒ½è®©åç«¯è½®è¯¢ n8n çŠ¶æ€ï¼Ÿ

**A**: 
- n8n API ä¸ä¸€å®šæš´éœ²æ‰§è¡ŒçŠ¶æ€æŸ¥è¯¢æ¥å£
- å¢åŠ åç«¯å¤æ‚åº¦å’Œ n8n æœåŠ¡å™¨å‹åŠ›
- å›è°ƒæ¨¡å¼æ›´é«˜æ•ˆï¼Œæ˜¯æ ‡å‡†åšæ³•

### Q2: å¦‚æœ n8n å›è°ƒå¤±è´¥æ€ä¹ˆåŠï¼Ÿ

**A**: å¯ä»¥æ·»åŠ å¤‡ç”¨æ–¹æ¡ˆï¼š
1. n8n å›è°ƒæ—¶è®¾ç½®é‡è¯•ï¼ˆn8n èŠ‚ç‚¹é…ç½®ï¼‰
2. åç«¯å®šæ—¶æ¸…ç†è¶…æ—¶ä»»åŠ¡ï¼ˆå¦‚72å°æ—¶åæ ‡è®°ä¸ºå¤±è´¥ï¼‰
3. å‰ç«¯æ˜¾ç¤º"ç”Ÿæˆè¶…æ—¶"æç¤º

### Q3: è§†é¢‘ URL çš„åŸŸåå¯ä»¥ä¿®æ”¹å—ï¼Ÿ

**A**: å¯ä»¥ã€‚åœ¨ n8n å›è°ƒèŠ‚ç‚¹ä¸­ä¿®æ”¹ `videoUrl` çš„æ„å»ºé€»è¾‘ï¼š
```javascript
{
  "status": "completed",
  "videoUrl": "https://your-cdn.com/videos/{{ $json.filename }}"
}
```

### Q4: å¦‚ä½•ç›‘æ§ç”Ÿæˆè¿›åº¦ï¼Ÿ

**A**: 
- å½“å‰å®ç°ï¼šå‰ç«¯åªæ˜¾ç¤º 10%ï¼ˆå·²æäº¤ï¼‰æˆ– 100%ï¼ˆå·²å®Œæˆï¼‰
- æ”¹è¿›æ–¹æ¡ˆï¼šn8n å¯ä»¥åœ¨å…³é”®æ­¥éª¤ï¼ˆéŸ³é¢‘å®Œæˆã€è§†é¢‘å®Œæˆã€èåˆå®Œæˆï¼‰åˆ†åˆ«å›è°ƒï¼Œæ›´æ–° progress å­—æ®µ

---

## æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å‰ç«¯      â”‚
â”‚ (Browser)   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ POST /api/drama/generate-video
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   åç«¯          â”‚
â”‚ (Node.js 3001)  â”‚
â”‚                 â”‚
â”‚ 1. åˆ›å»ºä»»åŠ¡     â”‚
â”‚ 2. è°ƒç”¨ n8n     â”‚â—„â”€â”€â”€â”
â”‚ 3. è¿”å› taskId  â”‚    â”‚
â”‚                 â”‚    â”‚
â”‚ GET /api/drama/ â”‚    â”‚
â”‚     task/:id    â”‚    â”‚
â”‚ è½®è¯¢ä»»åŠ¡çŠ¶æ€    â”‚    â”‚
â”‚                 â”‚    â”‚
â”‚ POST /api/drama/â”‚    â”‚
â”‚   callback/:id  â”‚â—„â”€â”€â”€â”¤ 7. å›è°ƒé€šçŸ¥å®Œæˆ
â”‚ æ›´æ–°ä»»åŠ¡çŠ¶æ€    â”‚    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
       â”‚                â”‚
       â”‚ è°ƒç”¨ webhook   â”‚
       â–¼                â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚   n8n Workflow  â”‚    â”‚
â”‚ (49.235.210.6)  â”‚    â”‚
â”‚                 â”‚    â”‚
â”‚ 1. æ¥æ”¶åˆ†é•œ     â”‚    â”‚
â”‚ 2. éŸ³é¢‘ç”Ÿæˆâ”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¤
â”‚ 3. è§†é¢‘ç”Ÿæˆ     â”‚    â”‚ è°ƒç”¨
â”‚ 4. èåˆä»»åŠ¡     â”‚    â”‚ ComfyUI
â”‚ 5. åˆå¹¶æœ€ç»ˆè§†é¢‘ â”‚    â”‚ APIs
â”‚ 6. å›è°ƒåç«¯ â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å¤–éƒ¨æœåŠ¡      â”‚
â”‚                 â”‚
â”‚ ComfyUI API     â”‚
â”‚ (8001)          â”‚
â”‚                 â”‚
â”‚ Fusion API      â”‚
â”‚ (8002)          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æ–‡ä»¶ä½ç½®

- **å‰ç«¯ä»£ç **: `/var/www/first_book_v2/frontend/src/pages/portfolio/PortfolioCreate.tsx`
- **åç«¯ä»£ç **: `/var/www/first_book_v2/backend/server.js`
- **n8n Workflow**: `story_final_from_scenes` (éœ€è¦åœ¨ n8n ç•Œé¢ç¼–è¾‘)
- **åç«¯æ—¥å¿—**: `/tmp/writetalent_deepseek.log`
- **æ‰‹åŠ¨æ›´æ–°è„šæœ¬**: `/tmp/update_video_task.sh`

---

## æ€»ç»“

**é—®é¢˜**ï¼šn8n æ‰§è¡Œå®Œæˆåä¸é€šçŸ¥åç«¯

**è§£å†³**ï¼šåœ¨ n8n workflow æœ€åæ·»åŠ  HTTP Request å›è°ƒèŠ‚ç‚¹

**ä¸´æ—¶æ–¹æ¡ˆ**ï¼šæ‰‹åŠ¨è°ƒç”¨å›è°ƒæ¥å£æ›´æ–°ä»»åŠ¡çŠ¶æ€

**é…ç½®å®Œæˆå**ï¼šæ•´ä¸ªæµç¨‹å°†å®Œå…¨è‡ªåŠ¨åŒ–ï¼Œæ— éœ€äººå·¥å¹²é¢„

