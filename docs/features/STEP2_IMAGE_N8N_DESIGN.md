# Step 2 图像生成迁移到 n8n 设计方案讨论

## 📋 需求概述

**目标**：将 Step 2 的图像生成从后端直连 ComfyUI 改为通过 n8n workflow 实现

**当前实现**（backend/services/comfyService.js）：
```
后端 → 直连 ComfyUI API → 轮询结果 → 返回图片 URL
- 串行处理：逐个场景顺序生成
- 同步等待：每张图等待完成（约3秒）
- 6张图 = 约18秒总时长
```

**期望实现**：
```
后端 → n8n webhook → n8n 调用 ComfyUI → 回调后端 → 返回图片 URL 列表
- 输入：多个 Image Prompt（DeepSeek 生成）
- 输出：URL 列表 ["url1", "url2", ...]
- 生成速度：1张图约3秒
```

---

## 🤔 关键设计决策点

### 决策 1：回调 vs 同步等待

#### 选项 A：使用回调（异步模式）

**流程**：
```
1. 后端调用 n8n webhook，传入所有 Image Prompts
2. n8n 立即返回 200，后端返回 jobId 给前端
3. 前端轮询 /api/ai/image-jobs/:jobId
4. n8n 后台生成图片（18秒）
5. n8n 回调后端 /api/ai/image-callback/:jobId
6. 前端轮询到 completed 状态，获取图片 URL 列表
```

**优点**：
- ✅ 与 Step 6 视频生成保持一致的交互模式
- ✅ 适合未来并行化扩展
- ✅ 不阻塞后端线程
- ✅ 用户体验更好（有进度反馈）

**缺点**：
- ❌ 增加复杂度（需要轮询）
- ❌ 对于快速任务（18秒），轮询略显多余
- ❌ 需要前端修改（增加轮询逻辑）

#### 选项 B：同步等待（现状保持）

**流程**：
```
1. 后端调用 n8n webhook，传入所有 Image Prompts
2. n8n 同步等待所有图片生成完成（18秒）
3. n8n 直接返回图片 URL 列表
4. 后端立即返回给前端
```

**优点**：
- ✅ 实现简单，前端无需修改
- ✅ 对于快速任务（<30秒），体验更直接
- ✅ 少一轮网络往返

**缺点**：
- ❌ webhook 响应时间可能超时（n8n 默认 8 秒）
- ❌ 不适合未来并行化（多台机器）
- ❌ 如果任务失败，前端体验差（直接报错，无法重试单个失败的图片）

---

### 决策 2：n8n Workflow 设计

#### 选项 A：并行生成所有图片

**流程**：
```
[接收 Image Prompts] 
    → [Split Into Batches (并行)] 
    → [调用 ComfyUI API] × N（并行）
    → [Merge 结果] 
    → [回调后端]
```

**优点**：
- ✅ 生成速度最快（理论 3 秒，如果有 6 台机器）
- ✅ 充分利用多台 ComfyUI 机器

**缺点**：
- ❌ 单台机器时无优势（反而可能因并发导致慢）
- ❌ 需要 ComfyUI 支持并发（需确认）

#### 选项 B：串行生成（与现状一致）

**流程**：
```
[接收 Image Prompts] 
    → [Loop: 分镜循环] 
    → [调用 ComfyUI API] (逐个)
    → [回调后端]
```

**优点**：
- ✅ 实现简单，与视频生成保持一致
- ✅ 单台机器稳定可靠
- ✅ 容易调试和监控

**缺点**：
- ❌ 速度慢（6张图 = 18秒）
- ❌ 无法利用多台机器的优势

#### 选项 C：混合模式（批量并行）

**流程**：
```
[接收 Image Prompts] 
    → [Split Into Batches (batch_size=2)] 
    → [Loop 批次]
        → [调用 ComfyUI API] × 2（并行）
    → [Merge 结果] 
    → [回调后端]
```

**优点**：
- ✅ 兼顾速度和稳定性
- ✅ 可根据机器数量调整 batch_size
- ✅ 逐步扩展（先 1 台 → 后多台）

**缺点**：
- ❌ 实现复杂度中等

---

### 决策 3：输出格式

#### 选项 A：返回 URL 列表（推荐）

**回调数据**：
```json
{
  "status": "completed",
  "images": [
    {"scene_id": 1, "imageUrl": "http://...png"},
    {"scene_id": 2, "imageUrl": "http://...png"}
  ]
}
```

**优点**：
- ✅ 包含场景 ID，前端容易对应
- ✅ 可附加元数据（尺寸、生成时间等）
- ✅ 支持部分成功（某些图失败可标记）

#### 选项 B：仅返回 URL 数组

**回调数据**：
```json
{
  "status": "completed",
  "imageUrls": ["http://...png", "http://...png"]
}
```

**优点**：
- ✅ 简单直接

**缺点**：
- ❌ 无场景对应关系（依赖顺序）
- ❌ 无法处理部分失败

---

### 决策 4：错误处理

#### 场景：如果 6 张图中有 1 张失败

**选项 A：全部失败**
- 回调 `status: "failed"`，前端重试全部

**选项 B：部分成功**
- 回调 `status: "completed_with_errors"`
- images 数组中失败的标记 `imageUrl: null, error: "..."`
- 前端仅重试失败的图片

**建议**：选项 B（部分成功）

---

## 💡 我的建议方案

### 第一阶段：快速迁移（保持现状体验）

**交互模式**：**同步等待**（选项 B）

**理由**：
- 图片生成快（18秒），在 n8n 默认超时内
- 前端无需修改，无缝替换
- 降低迁移风险

**Workflow 设计**：**串行生成**（选项 B）

**输出格式**：**URL 列表**（选项 A）

**错误处理**：**部分成功**（选项 B）

**实现**：
```
[Webhook 接收]
  → [解析 Image Prompts]
  → [Loop: 逐个生成]
      → [调用 ComfyUI API]
      → [轮询结果]
  → [汇总 URL 列表]
  → [同步返回 200 OK]
```

**n8n 配置**：
- Webhook 响应模式：`Last Node`（等待所有节点完成再返回）
- 超时：设置为 30 秒（足够 6 张图）

---

### 第二阶段：优化并行（上线后）

**交互模式**：**回调异步**（选项 A）

**理由**：
- 多台机器时生成时间不确定
- 支持更多场景（如 20 张图）

**Workflow 设计**：**批量并行**（选项 C）

**实现**：
```
[Webhook 接收]
  → [解析 Image Prompts]
  → [Split Batches (batch_size=并行度)]
  → [Loop 批次]
      → [并行调用 ComfyUI API]
  → [汇总 URL 列表]
  → [回调后端]
```

**前端修改**：
- 增加轮询 `/api/ai/image-jobs/:jobId`
- 显示进度（如 "生成第 3/6 张图片..."）

---

## 🎯 需要确认的问题

### 问题 1：n8n Webhook 响应模式

**当前 Step 6 视频生成**：
```json
"responseMode": "onReceived"  // 立即返回，不等待完成
```

**Step 2 图片生成（第一阶段）需要**：
```json
"responseMode": "lastNode"  // 等待所有节点完成再返回
```

**问题**：n8n 是否支持在 webhook 中同步等待 30 秒？

---

### 问题 2：ComfyUI API 调用方式

**当前 backend 直连**：
```javascript
POST http://49.235.210.6:8001/prompt
轮询 /history/:prompt_id
```

**n8n 中**：
- 是否也这样调用？
- 还是有专门的 API？
- 是否已有现成的图片生成 API（如 `/api/image/generate`）？

---

### 问题 3：并行度限制

**单台 ComfyUI 机器**：
- 最多支持几个并发请求？
- 并发是否会变慢？

**多台机器**：
- 如何负载均衡？
- n8n 是否需要维护机器列表？

---

### 问题 4：生成时间预估

**你提到**：1张图约3秒

**我的疑问**：
- 这是 ComfyUI 实际生成时间，还是包含网络传输？
- 6张图串行生成是 18 秒，还是可能更长？
- 是否在 30 秒内可以完成（n8n webhook 超时）？

---

## 📝 下一步

### 如果选择第一阶段方案（同步等待）

**我需要**：
1. ✅ 确认 n8n webhook 支持 `lastNode` 模式
2. ✅ 确认 ComfyUI API 调用方式
3. ✅ 创建 n8n workflow JSON（参考 `story_final_v2.json`）

**你需要**：
1. 确认 6 张图能在 30 秒内完成
2. 决定是否接受同步等待模式

### 如果选择第二阶段方案（回调异步）

**我需要**：
1. ✅ 创建 n8n workflow JSON（含回调节点）
2. ✅ 修改后端 `/api/ai/generate-story` API
3. ✅ 修改前端 `PortfolioCreate.tsx` 增加轮询逻辑

**你需要**：
1. 接受前端体验变化（轮询等待）
2. 测试回调流程

---

## ❓ 请回答

1. **你希望使用哪种交互模式？**
   - A. 同步等待（简单，18秒内返回）
   - B. 回调异步（复杂，但更灵活）

2. **6 张图能在 30 秒内完成吗？**
   - 如果不能，必须用回调模式

3. **ComfyUI API 调用方式是什么？**
   - 在 n8n 中是否已有现成的节点/API？

4. **单台机器支持几个并发？**
   - 决定第二阶段的 batch_size

5. **是否需要立即实现第二阶段（并行）？**
   - 还是先第一阶段，验证后再优化？

---

请告诉我你的决策，我会据此创建详细的实施方案！


